{% load tailwind_tags %}
{% tailwind_css %}
{% load static %}
<!-- path: core/templates/partials/process_slider.html -->
<section class="w-full px-6 py-10 text-[#322D29]">
  <div class="mx-auto max-w-5xl text-center">
    <h2 class="text-[42px] font-semibold">Nos processus</h2>
    <p class="mt-2 text-[16px] font-semibold">
      Notre approche est simple et rigoureuse. Nous croyons que c’est la qualité des petites étapes qui garantit la réussite des
      grands projets.
    </p>
  </div>

  <div id="process-slider" class="relative mt-8">
    <div id="ps-stage" class="relative mx-auto w-full max-w-[980px]" style="height: 360px; overflow: visible;"></div>
    <div id="ps-dots" class="mt-6 flex items-center justify-center gap-2"></div>
  </div>

  <style>
    .ps-card{
      position:absolute; top:50%; left:50%;
      width: min(720px, calc(100% - 40px)); /* s’adapte au viewport */
      border-radius: 1.5rem;
      background:#fff; text-align:center;
      padding:28px 24px;
      box-shadow:0 18px 40px rgba(0,0,0,.18);
      will-change: transform, opacity;
      transition: transform .45s ease, box-shadow .45s ease, opacity .3s ease;
    }
    .ps-card h3{ font-size:20px; font-weight:700; margin:0 0 10px }
    .ps-card p { font-size:14px; line-height:1.6; font-weight:500; margin:0 }

    .ps-center{ z-index:3; }
    .ps-side  { z-index:1; }
    .ps-hidden{ display:none; }

    .ps-faded .ps-fade-mask{
      content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background: rgba(255,255,255,.80);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.04);
    }

    .ps-center::after{
      content:""; position:absolute; left:50%; bottom:-14px; transform:translateX(-50%);
      width: 88%; height: 14px; border-radius: 9999px; background: rgba(0,0,0,.08); filter: blur(6px);
    }

    .ps-dot{ width:8px; height:8px; border-radius:9999px; background:#d4d4d4; }
    .ps-dot--active{ background:#111; }
  </style>

  <script>
    (function () {
      const SLIDES = [
        { title: "Plan stratégique",
          text: "Avant toute chose, nous veillons à bien arrimer nos services à votre vision d’affaires. Notre objectif est de comprendre vos priorités, vos défis et vos objectifs afin d’intégrer nos solutions de façon cohérente et utile." },
        { title: "Conseils Home Staging",
          text: "Nous proposons des recommandations sobres et efficaces pour valoriser vos espaces. Chaque intervention est pensée pour maximiser l’impact tout en respectant votre budget et votre clientèle cible." },
        { title: "Photographie et Vidéographie Immobilière",
          text: "Nous réalisons des visuels qui mettent vos propriétés en valeur avec justesse, sans artifice inutile. L’objectif est de capter l’attention des bons acheteurs ou locataires en montrant le plein potentiel de vos espaces." },
        { title: "Optimisation de votre visibilité avec équipe de marketing professionnel",
          text: "Nous vous accompagnons avec des conseils honnêtes et concrets pour améliorer la rentabilité et l’efficacité de vos immeubles. Notre approche est basée sur l’observation du terrain et l’analyse de données objectives." },
        { title: "Conseil en Optimisation Multi Logement",
          text: "Nous analysons vos immeubles locatifs sous tous les angles — occupation, positionnement, qualité perçue, revenus — afin d’identifier des leviers d’optimisation concrets pour un meilleur retour sur investissement." },
      ];

      const stage  = document.getElementById("ps-stage");
      const dots   = document.getElementById("ps-dots");
      const slider = document.getElementById("process-slider");

      let current = 0, timer = null;
      const INTERVAL = 5500;

      // Build cards
      const cards = SLIDES.map((s, i) => {
        const el = document.createElement("article");
        el.className = "ps-card ps-center";
        el.innerHTML = `
          <h3>${i+1}. ${s.title}</h3>
          <p>${s.text}</p>
          <div class="ps-fade-mask" aria-hidden="true" style="display:none"></div>
        `;
        stage.appendChild(el);
        return el;
      });

      // Dots
      const dotEls = SLIDES.map((_, i) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "ps-dot";
        b.setAttribute("aria-label", "Aller à la diapo " + (i+1));
        b.addEventListener("click", () => goTo(i, true));
        dots.appendChild(b);
        return b;
      });

      // Helpers responsive
      function getExposed(){ // largeur visible des cartes latérales
        const w = window.innerWidth;
        if (w >= 1024) return 160; // desktop
        if (w >= 640)  return 100; // tablet
        return 60;                 // mobile
      }
      function getSideScale(){
        const w = window.innerWidth;
        if (w >= 1024) return 0.93;
        if (w >= 640)  return 0.92;
        return 0.90;
      }

      function posOf(i){
        const diff = i - current;
        if (diff === 0) return "center";
        if (diff === -1 || diff === SLIDES.length - 1) return "left";
        if (diff ===  1 || diff === -SLIDES.length + 1) return "right";
        return "hidden";
      }

      function setTransform(card, pos, cardW){
        const exposed = getExposed();
        const scale   = getSideScale();
        const shift   = Math.max(80, Math.round(cardW / 2 - exposed)); // décalage dynamique

        if (pos === "center") {
          card.style.transform = "translate3d(-50%, -50%, 0) scale(1)";
        } else if (pos === "left") {
          card.style.transform = `translate3d(calc(-50% - ${shift}px), -50%, 0) scale(${scale})`;
        } else if (pos === "right") {
          card.style.transform = `translate3d(calc(-50% + ${shift}px), -50%, 0) scale(${scale})`;
        }
      }

      function paint(){
        const refW = cards[0].getBoundingClientRect().width;

        cards.forEach((card, i) => {
          const pos = posOf(i);
          card.classList.remove("ps-center","ps-side","ps-hidden","ps-faded");

          if (pos === "center") card.classList.add("ps-center");
          else if (pos === "hidden") card.classList.add("ps-hidden");
          else card.classList.add("ps-side");

          // side fade
          const faded = (pos === "left" || pos === "right");
          const mask = card.querySelector(".ps-fade-mask");
          faded ? (card.classList.add("ps-faded"), mask.style.display = "") : (mask.style.display = "none");

          // shadow
          card.style.boxShadow = (pos === "center")
            ? "0 18px 40px rgba(0,0,0,.18)"
            : "0 10px 26px rgba(0,0,0,.10)";

          setTransform(card, pos, refW);
        });

        dotEls.forEach((d, i) => d.classList.toggle("ps-dot--active", i === current));
      }

      function layout(){
        // hauteur scène = max des cartes (pour éviter les chevauchements)
        let maxH = 0;
        cards.forEach(el => { el.style.transform = "translate3d(-50%, -50%, 0)"; maxH = Math.max(maxH, el.offsetHeight); });
        stage.style.height = (maxH || 360) + "px";
        paint();
      }

      function next(){ current = (current + 1) % SLIDES.length; paint(); }
      function goTo(i, reset){ current = i % SLIDES.length; paint(); if (reset){ stop(); start(); } }
      function start(){ if (!timer) timer = setInterval(next, INTERVAL); }
      function stop(){ if (timer){ clearInterval(timer); timer = null; } }

      slider.addEventListener("mouseenter", stop);
      slider.addEventListener("mouseleave", start);
      let t; window.addEventListener("resize", () => { clearTimeout(t); t = setTimeout(layout, 120); });

      layout(); start();
    })();
  </script>
</section>